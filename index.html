<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯Ø§Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ù…Ù†ÙŠØ© (IAT) - Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø§ÙˆØ³</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            text-align: center;
            background-color: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            cursor: default; /* Ø´ÙƒÙ„ Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
        }

        /* =========================================
           Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø© (ÙŠØ³Ø§Ø± ÙˆÙŠÙ…ÙŠÙ†)
           ========================================= */
        .click-zone {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 50%;
            z-index: 5; /* ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„ÙƒÙ† ØªØ­Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª */
            cursor: pointer; /* Ø¸Ù‡ÙˆØ± ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
            transition: background 0.2s;
        }

        #left-zone {
            left: 0;
            border-right: 1px solid rgba(255,255,255,0.1); /* Ø®Ø· ÙØ§ØµÙ„ Ø®ÙÙŠÙ */
        }

        #right-zone {
            right: 0;
        }

        /* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§ÙˆØ³ Ù„ÙŠØ¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙƒØ§Ù†Ù‡ */
        #left-zone:hover { background: rgba(52, 152, 219, 0.05); }
        #right-zone:hover { background: rgba(52, 152, 219, 0.05); }

        /* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
        .click-zone:active { background: rgba(52, 152, 219, 0.2) !important; }


        /* =========================================
           Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
           ========================================= */
        #main-container {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* ÙŠØ³Ù…Ø­ Ù„Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
            z-index: 10;
        }

        .header-labels {
            position: absolute;
            top: 30px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 80px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„Ø­ÙˆØ§Ù */
            box-sizing: border-box;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .left-label { text-align: left; }
        .right-label { text-align: right; }

        #stimulus-box {
            font-size: 5rem;
            font-weight: 900;
            padding: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #error-msg {
            color: #e74c3c;
            font-size: 6rem;
            font-weight: bold;
            position: absolute;
            top: 65%;
            display: none;
            z-index: 20;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }

        /* =========================================
           Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
           ========================================= */
        #instructions {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50;
            z-index: 100; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        input {
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 8px;
            border: none;
            margin: 15px 0;
            text-align: center;
            width: 300px;
            font-family: 'Tajawal';
        }

        button {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal';
            box-shadow: 0 4px 0 #1e8449;
            z-index: 101; /* Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø§Ø¨Ù„ÙŠØªÙ‡ Ù„Ù„Ø¶ØºØ· */
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        .hidden { display: none !important; }
        
        /* Ù…Ø¤Ø´Ø± Ù„Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© */
        .divider {
            position: absolute;
            top: 10%; bottom: 10%;
            left: 50%;
            width: 2px;
            background: rgba(255,255,255,0.1);
            transform: translateX(-50%);
        }

    </style>
</head>
<body>

    <div id="left-zone" class="click-zone" onclick="handleInput('left')"></div>
    <div id="right-zone" class="click-zone" onclick="handleInput('right')"></div>

    <div id="instructions">
        <h1>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯Ø§Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ù…Ù†ÙŠØ© (IAT)</h1>
        <p style="font-size: 1.2rem; max-width: 600px; line-height: 1.6;">
            Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØµÙ…Ù… Ù„Ù„Ù…Ø§ÙˆØ³ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ù„Ù…Ø³ (Touchpad).<br>
            <span style="color:#f1c40f">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</span><br>
            Ø§Ø¶ØºØ· ÙÙŠ <strong>Ø£ÙŠ Ù…ÙƒØ§Ù†</strong> Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙŠØ³Ø±Ù‰.<br>
            Ø§Ø¶ØºØ· ÙÙŠ <strong>Ø£ÙŠ Ù…ÙƒØ§Ù†</strong> Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰.
        </p>
        
        <input type="text" id="student-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
        <button onclick="startExperiment()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </div>

    <div id="main-container" class="hidden">
        <div class="divider"></div> <div class="header-labels">
            <div id="left-label" class="left-label">...</div>
            <div id="right-label" class="right-label">...</div>
        </div>

        <div id="stimulus-box">Ø§Ø³ØªØ¹Ø¯</div>
        <div id="error-msg">âŒ</div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-x3V9b59wH5N1W2d31tV9T7q2JtC8i5L7B3kG-uQ4U6X7GqfQz-bK5vX0M7J2v0o/exec"; 

        const categories = {
            flowers: ["Ø£ÙˆØ±ÙƒÙŠØ¯", "ØªÙˆÙ„ÙŠØ¨", "ÙˆØ±Ø¯", "ÙŠØ§Ø³Ù…ÙŠÙ†", "Ù†Ø±Ø¬Ø³", "Ù„ÙŠÙ„Ùƒ", "Ù„ÙˆØªØ³"],
            insects: ["Ø¯Ø¨ÙˆØ±", "Ø¨Ø±ØºÙˆØ«", "Ø¹Ù†ÙƒØ¨ÙˆØª", "ØµØ±ØµÙˆØ±", "Ø¨Ø¹ÙˆØ¶Ø©", "Ù†Ù…Ù„Ø©", "Ø°Ø¨Ø§Ø¨"],
            good: ["Ø±Ø§Ø¦Ø¹", "Ø¬Ù…ÙŠÙ„", "Ø³Ø¹ÙŠØ¯", "Ø­Ø¨", "ÙØ±Ø­", "Ø³Ù„Ø§Ù…", "Ù†Ø¬Ø§Ø­"],
            bad: ["Ù‚Ø¨ÙŠØ­", "ÙØ§Ø´Ù„", "Ø­Ø²Ù†", "Ø£Ù„Ù…", "Ø´Ø±", "ÙƒØ±Ù‡", "Ù…Ø±Ø¶"]
        };

        const blocks = [
            { type: 'practice', left: ['flowers'], right: ['insects'], trials: 4 },
            { type: 'practice', left: ['good'], right: ['bad'], trials: 4 },
            { type: 'test_compatible', left: ['flowers', 'good'], right: ['insects', 'bad'], trials: 10 },
            { type: 'practice_reverse', left: ['insects'], right: ['flowers'], trials: 6 },
            { type: 'test_incompatible', left: ['insects', 'good'], right: ['flowers', 'bad'], trials: 12 }
        ];

        let currentBlock = 0;
        let currentTrial = 0;
        let blockTrials = [];
        let results = [];
        let startTime = 0;
        let studentName = "";
        let waitingForCorrection = false;

        function startExperiment() {
            const name = document.getElementById('student-name').value.trim();
            if (!name) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…"); return; }
            studentName = name;

            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');
            startBlock();
        }

        function startBlock() {
            if (currentBlock >= blocks.length) {
                finishExperiment();
                return;
            }

            const block = blocks[currentBlock];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
            document.getElementById('left-label').innerHTML = block.left.map(getLabel).join("<br>");
            document.getElementById('right-label').innerHTML = block.right.map(getLabel).join("<br>");
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            updateColors(block);

            blockTrials = generateTrials(block);
            currentTrial = 0;
            waitingForCorrection = false;
            
            setTimeout(nextTrial, 500);
        }

        function updateColors(block) {
            const isLeftBad = block.left.includes('bad') || block.left.includes('insects');
            const isRightBad = block.right.includes('bad') || block.right.includes('insects');

            document.getElementById('left-label').style.color = isLeftBad ? "#e74c3c" : "#3498db";
            document.getElementById('right-label').style.color = isRightBad ? "#e74c3c" : "#3498db";
        }

        function getLabel(cat) {
            if(cat === 'flowers') return "Ø²Ù‡ÙˆØ± ğŸŒ¸";
            if(cat === 'insects') return "Ø­Ø´Ø±Ø§Øª ğŸ¦—";
            if(cat === 'good') return "ÙƒÙ„Ù…Ø§Øª Ø¬ÙŠØ¯Ø© ğŸ‘";
            if(cat === 'bad') return "ÙƒÙ„Ù…Ø§Øª Ø³ÙŠØ¦Ø© ğŸ‘";
            return "";
        }

        function generateTrials(block) {
            let trials = [];
            for (let i = 0; i < block.trials; i++) {
                const isLeft = Math.random() < 0.5;
                const sideCats = isLeft ? block.left : block.right;
                const category = sideCats[Math.floor(Math.random() * sideCats.length)];
                const word = categories[category][Math.floor(Math.random() * categories[category].length)];
                
                trials.push({
                    word: word,
                    category: category,
                    correctSide: isLeft ? 'left' : 'right'
                });
            }
            return trials;
        }

        function nextTrial() {
            if (currentTrial >= blockTrials.length) {
                currentBlock++;
                startBlock();
                return;
            }

            const trial = blockTrials[currentTrial];
            document.getElementById('stimulus-box').textContent = trial.word;
            document.getElementById('error-msg').style.display = 'none';
            waitingForCorrection = false;

            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
            if (categories.good.includes(trial.word)) document.getElementById('stimulus-box').style.color = "#3498db";
            else if (categories.bad.includes(trial.word)) document.getElementById('stimulus-box').style.color = "#e74c3c";
            else document.getElementById('stimulus-box').style.color = "#ecf0f1";

            startTime = Date.now();
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª (Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø´ÙØ§ÙØ©)
        function handleInput(side) {
            if (currentBlock >= blocks.length) return;

            const trial = blockTrials[currentTrial];
            
            if (waitingForCorrection) {
                if (side === trial.correctSide) {
                    document.getElementById('error-msg').style.display = 'none';
                    waitingForCorrection = false;
                    currentTrial++;
                    setTimeout(nextTrial, 150);
                }
                return;
            }

            const endTime = Date.now();
            const rt = endTime - startTime;

            if (side === trial.correctSide) {
                if (blocks[currentBlock].type.includes('test')) {
                    results.push({ block: blocks[currentBlock].type, rt: rt, correct: true });
                }
                currentTrial++;
                setTimeout(nextTrial, 150);
            } else {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø£ ÙˆØ¥Ø¬Ø¨Ø§Ø± Ø§Ù„ØªØµØ­ÙŠØ­
                document.getElementById('error-msg').style.display = 'block';
                waitingForCorrection = true;
            }
        }

        function finishExperiment() {
            document.getElementById('main-container').classList.add('hidden');
            // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø± Ø­ØªÙ‰ Ù„Ø§ ØªØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            document.getElementById('left-zone').style.display = 'none';
            document.getElementById('right-zone').style.display = 'none';

            document.getElementById('instructions').innerHTML = "<h2 style='color:#f1c40f'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</h2>";
            document.getElementById('instructions').classList.remove('hidden');

            const compTrials = results.filter(r => r.block === 'test_compatible');
            const incompTrials = results.filter(r => r.block === 'test_incompatible');
            const avgComp = compTrials.reduce((sum, r) => sum + r.rt, 0) / (compTrials.length || 1);
            const avgIncomp = incompTrials.reduce((sum, r) => sum + r.rt, 0) / (incompTrials.length || 1);
            const diff = avgIncomp - avgComp;
            
            let interpretation = "Ø­ÙŠØ§Ø¯ÙŠ";
            if (diff > 50) interpretation = "Ø§Ù†Ø­ÙŠØ§Ø² Ù„Ù„Ø²Ù‡ÙˆØ± (Ø·Ø¨ÙŠØ¹ÙŠ)";
            else if (diff < -50) interpretation = "Ø§Ù†Ø­ÙŠØ§Ø² Ù„Ù„Ø­Ø´Ø±Ø§Øª";

            const dataToSend = {
                student_name: studentName,
                test_type: "IAT (Mouse Version)",
                score: Math.round(diff) + " ms",
                details: `Comp: ${Math.round(avgComp)}ms | Incomp: ${Math.round(avgIncomp)}ms`,
                interpretation: interpretation
            };

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dataToSend)
            }).then(() => {
                document.getElementById('instructions').innerHTML = `
                    <h1 style="color:#27ae60">ØªÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!</h1>
                    <p>Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${interpretation}</p>
                    <button onclick="location.reload()">Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                `;
            });
        }
    </script>
</body>
</html>
