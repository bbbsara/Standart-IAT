<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØ¯Ø§Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ù…Ù†ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (Standard IAT)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #222; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ø¹ÙŠÙ† ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² */
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            touch-action: manipulation;
            overflow: hidden; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        }

        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .header-labels {
            display: flex;
            justify-content: space-between;
            width: 95%;
            margin: 10px auto;
            font-size: 22px; /* Ø­Ø¬Ù… Ø®Ø· Ù…Ù†Ø§Ø³Ø¨ */
            font-weight: bold;
        }

        .label-box {
            width: 45%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }

        .left-label { text-align: right; color: #3498db; border-bottom: 4px solid #3498db; }
        .right-label { text-align: left; color: #2ecc71; border-bottom: 4px solid #2ecc71; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
        .stimulus-box {
            font-size: 60px; /* ÙƒÙ„Ù…Ø© ÙƒØ¨ÙŠØ±Ø© ÙˆÙˆØ§Ø¶Ø­Ø© */
            font-weight: 900;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            color: #fff;
            text-shadow: 0 4px 15px rgba(0,0,0,0.7);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„) */
        .response-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 140px; /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ø±ÙŠØ­ Ù„Ù„Ø¥Ø¨Ù‡Ø§Ù… */
            display: flex;
            z-index: 100;
        }

        .btn-resp {
            width: 50%;
            border: none;
            font-family: 'Tajawal';
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.9;
            transition: 0.1s;
        }
        
        .btn-left { background-color: #2c3e50; color: #3498db; border-right: 2px solid #444; }
        .btn-right { background-color: #2c3e50; color: #2ecc71; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· (Feedback) */
        .btn-resp:active { background-color: #555; }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ */
        #error-msg {
            color: #e74c3c;
            font-size: 50px;
            font-weight: bold;
            visibility: hidden;
            height: 60px;
        }

        .instruction-screen {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            margin: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .btn-start {
            background: #27ae60;
            color: white;
            padding: 15px 50px;
            border: none;
            border-radius: 8px;
            font-size: 22px;
            margin-top: 20px;
            cursor: pointer;
            font-family: 'Tajawal';
            font-weight: bold;
        }

        .hidden { display: none !important; }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªÙˆØ¶ÙŠØ­ */
        .word-good { color: #2ecc71; } /* Ø£Ø®Ø¶Ø± Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¬ÙŠØ¯Ø© */
        .word-bad { color: #e74c3c; }  /* Ø£Ø­Ù…Ø± Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³ÙŠØ¦Ø© */
        .word-neutral { color: #ecf0f1; } /* Ø£Ø¨ÙŠØ¶ Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ */

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 600px) {
            .header-labels { font-size: 16px; }
            .stimulus-box { font-size: 45px; }
            .btn-resp { font-size: 20px; height: 120px; }
        }

    </style>
</head>
<body>

    <div id="start-screen" class="instruction-screen">
        <h1 style="color:#2c3e50;">Ø§Ø®ØªØ¨Ø§Ø± IAT Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ</h1>
        <p style="font-size:18px;">ÙŠØªÙƒÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† <strong>7 Ù…Ø±Ø§Ø­Ù„</strong> Ù…ØªØªØ§Ø¨Ø¹Ø©.</p>
        
        <div style="text-align: right; background:#f9f9f9; padding:15px; border-radius:10px; margin:15px 0;">
            <p>ğŸ“Œ <strong>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong> ØªØµÙ†ÙŠÙ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø³Ø±Ø¹Ø© ÙˆØ¯Ù‚Ø©.</p>
            <p>ğŸ‘ˆ Ø§Ø¶ØºØ· <strong>ÙŠØ³Ø§Ø±</strong> Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ…ÙŠ Ù„Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ÙŠØ³Ø±.</p>
            <p>ğŸ‘‰ Ø§Ø¶ØºØ· <strong>ÙŠÙ…ÙŠÙ†</strong> Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ…ÙŠ Ù„Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ÙŠÙ…Ù†.</p>
            <p>âš ï¸ <strong>Ø§Ù†ØªØ¨Ù‡:</strong> Ø³ØªØªØºÙŠØ± Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</p>
        </div>

        <input type="text" id="student-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù‡Ù†Ø§" 
               style="padding:15px; width:80%; font-size:18px; border:2px solid #ddd; border-radius:8px; text-align:center; margin-bottom:15px;">
        <br>
        <button class="btn-start" onclick="initTest()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </div>

    <div id="test-screen" class="container hidden">
        
        <div class="header-labels">
            <div id="label-left" class="label-box left-label">...</div>
            <div id="label-right" class="label-box right-label">...</div>
        </div>

        <div id="stimulus" class="stimulus-box">...</div>
        <div id="error-msg">âŒ</div>

        <div class="response-area">
            <button class="btn-resp btn-left" onmousedown="handleInput('left')" ontouchstart="handleInput('left')">Ø§Ù„ÙŠØ³Ø§Ø±</button>
            <button class="btn-resp btn-right" onmousedown="handleInput('right')" ontouchstart="handleInput('right')">Ø§Ù„ÙŠÙ…ÙŠÙ†</button>
        </div>
    </div>

    <div id="end-screen" class="instruction-screen hidden">
        <h1 style="color:#27ae60">âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
        <p style="font-size:20px;">ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ù„Ø§ÙˆØ§Ø¹ÙŠØ©.</p>
        <hr>
        <div id="result-display" style="font-weight:bold; margin:20px; font-size:22px; color:#2c3e50;">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...
        </div>
        <p style="color:gray; font-size:14px;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        <button class="btn-start" onclick="location.reload()" style="background:#34495e;">Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <script>
        // ==========================================
        //  Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ù…Ø¯Ù…Ø¬ Ø¬Ø§Ù‡Ø²)
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwbCrZKaEWWAfFy3csc-fUzfJv4CzjqEYRY1dC60rpscTe65CffuyA25ViS207AtaRS/exec"; 
        // ==========================================

        // --- 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ø²Ù‡ÙˆØ±/Ø­Ø´Ø±Ø§Øª + Ø¬ÙŠØ¯/Ø³ÙŠØ¡) ---
        const categories = {
            target1: { name: "Ø²Ù‡ÙˆØ± ğŸŒ¸", words: ["ÙŠØ§Ø³Ù…ÙŠÙ†", "Ø¬ÙˆØ±ÙŠ", "Ù†Ø±Ø¬Ø³", "ØªÙˆÙ„ÙŠØ¨", "Ø³ÙˆØ³Ù†", "Ù‚Ø±Ù†ÙÙ„"], type: "neutral" },
            target2: { name: "Ø­Ø´Ø±Ø§Øª ğŸ¦—", words: ["ØµØ±ØµÙˆØ±", "Ø°Ø¨Ø§Ø¨Ø©", "Ø¨Ø¹ÙˆØ¶Ø©", "Ø¯Ø¨ÙˆØ±", "Ø®ÙØ³Ø§Ø¡", "Ø¹Ù†ÙƒØ¨ÙˆØª"], type: "neutral" },
            attr1:   { name: "Ø¬ÙŠØ¯ ğŸ‘", words: ["Ø­Ø¨", "Ø³Ù„Ø§Ù…", "ÙØ±Ø­", "Ù†Ø¬Ø§Ø­", "Ø¬Ù†Ø©", "ØµØ­Ø©"], type: "good" },
            attr2:   { name: "Ø³ÙŠØ¡ ğŸ‘", words: ["ÙƒØ±Ù‡", "Ø­Ø±Ø¨", "Ø£Ù„Ù…", "ÙØ´Ù„", "Ø¬Ø­ÙŠÙ…", "Ù…Ø±Ø¶"], type: "bad" }
        };

        // --- 2. Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù€ 7 (Standard IAT Structure) ---
        let blocks = [
            { type: "practice", left: ["target1"], right: ["target2"], trials: 10, info: "Ù…Ø±Ø­Ù„Ø© 1: ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªØµÙ†ÙŠÙ (Ø²Ù‡ÙˆØ± / Ø­Ø´Ø±Ø§Øª)" },
            { type: "practice", left: ["attr1"], right: ["attr2"], trials: 10, info: "Ù…Ø±Ø­Ù„Ø© 2: ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØµÙØ§Øª (Ø¬ÙŠØ¯ / Ø³ÙŠØ¡)" },
            { type: "test_compatible", left: ["target1", "attr1"], right: ["target2", "attr2"], trials: 20, info: "Ù…Ø±Ø­Ù„Ø© 3: Ø¯Ù…Ø¬ (Ø²Ù‡ÙˆØ±+Ø¬ÙŠØ¯ / Ø­Ø´Ø±Ø§Øª+Ø³ÙŠØ¡)" },
            { type: "test_compatible", left: ["target1", "attr1"], right: ["target2", "attr2"], trials: 40, info: "Ù…Ø±Ø­Ù„Ø© 4: ØªÙƒØ«ÙŠÙ Ø§Ù„Ø¯Ù…Ø¬" }, 
            { type: "practice_reverse", left: ["target2"], right: ["target1"], trials: 20, info: "Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù†ØªØ¨Ù‡! ØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† (Ø­Ø´Ø±Ø§Øª / Ø²Ù‡ÙˆØ±)" }, 
            { type: "test_incompatible", left: ["target2", "attr1"], right: ["target1", "attr2"], trials: 20, info: "Ù…Ø±Ø­Ù„Ø© 6: Ø¯Ù…Ø¬ Ø¹ÙƒØ³ÙŠ (Ø­Ø´Ø±Ø§Øª+Ø¬ÙŠØ¯ / Ø²Ù‡ÙˆØ±+Ø³ÙŠØ¡)" },
            { type: "test_incompatible", left: ["target2", "attr1"], right: ["target1", "attr2"], trials: 40, info: "Ù…Ø±Ø­Ù„Ø© 7: ØªÙƒØ«ÙŠÙ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø¹ÙƒØ³ÙŠ" }
        ];

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        let currentBlock = 0;
        let trialIndex = 0;
        let trialQueue = [];
        let currentStimulus = null;
        let startTime = 0;
        let isBlockRunning = false;
        let studentName = "";
        
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        let results = {
            compatibleTimes: [],
            incompatibleTimes: [],
            totalErrors: 0
        };

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ ---

        function initTest() {
            const name = document.getElementById('student-name').value.trim();
            if(!name) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹"); return; }
            studentName = name;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('test-screen').classList.remove('hidden');
            
            // Ø·Ù„Ø¨ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„
            try { document.documentElement.requestFullscreen(); } catch(e){}

            startBlock(0);
        }

        function startBlock(blockIdx) {
            currentBlock = blockIdx;
            if (currentBlock >= blocks.length) {
                finishExperiment();
                return;
            }

            const blockInfo = blocks[currentBlock];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            const leftNames = blockInfo.left.map(k => categories[k].name).join(" + ");
            const rightNames = blockInfo.right.map(k => categories[k].name).join(" + ");
            
            document.getElementById('label-left').textContent = leftNames;
            document.getElementById('label-right').textContent = rightNames;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù‚ØµÙŠØ±Ø© Ù‚Ø¨Ù„ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©
            const stimBox = document.getElementById('stimulus');
            stimBox.textContent = blockInfo.info;
            stimBox.style.fontSize = "30px";
            stimBox.className = "stimulus-box"; // reset colors
            isBlockRunning = false;

            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
            generateTrials(blockInfo);
            
            // Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø«Ù… Ø§Ù„Ø¨Ø¯Ø¡
            setTimeout(nextTrial, 3000);
        }

        function generateTrials(blockInfo) {
            trialQueue = [];
            let possibleStimuli = [];

            blockInfo.left.forEach(key => {
                categories[key].words.forEach(w => {
                    possibleStimuli.push({ word: w, correctSide: 'left', type: categories[key].type });
                });
            });

            blockInfo.right.forEach(key => {
                categories[key].words.forEach(w => {
                    possibleStimuli.push({ word: w, correctSide: 'right', type: categories[key].type });
                });
            });

            for(let i=0; i<blockInfo.trials; i++) {
                const rand = possibleStimuli[Math.floor(Math.random() * possibleStimuli.length)];
                trialQueue.push(rand);
            }
            trialIndex = 0;
        }

        function nextTrial() {
            if (trialIndex >= trialQueue.length) {
                startBlock(currentBlock + 1);
                return;
            }

            currentStimulus = trialQueue[trialIndex];
            const stimBox = document.getElementById('stimulus');
            stimBox.textContent = currentStimulus.word;
            stimBox.style.fontSize = "60px";
            
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
            stimBox.className = "stimulus-box";
            if(currentStimulus.type === '
