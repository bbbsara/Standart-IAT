<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø§Ø¨Ø· Ø§Ù„Ø¶Ù…Ù†ÙŠ (IAT)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            text-align: center;
            background-color: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            cursor: default;
        }

        /* Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø´ÙØ§ÙØ© */
        .click-zone {
            position: fixed; top: 0; bottom: 0; width: 50%; z-index: 5; cursor: pointer;
        }
        #left-zone { left: 0; border-right: 1px solid rgba(255,255,255,0.05); }
        #right-zone { right: 0; }
        
        /* ØªØ£Ø«ÙŠØ± Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± */
        .click-zone:active { background: rgba(52, 152, 219, 0.1); }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #main-container {
            position: relative; height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: none; z-index: 10;
        }

        /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .header-labels {
            position: absolute; top: 30px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 80px; box-sizing: border-box;
            font-size: 2rem; font-weight: bold;
        }
        .left-label { text-align: left; }
        .right-label { text-align: right; }

        /* Ø§Ù„ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
        #stimulus-box {
            font-size: 5rem; font-weight: 900; padding: 40px;
            background: rgba(0,0,0,0.3); border-radius: 20px;
        }

        /* Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø·Ø£ */
        #error-msg {
            color: #e74c3c; font-size: 6rem; font-weight: bold;
            position: absolute; top: 65%; display: none; z-index: 20;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #instructions {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
        }

        .instruction-box {
            background: rgba(0,0,0,0.2);
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 1.1rem;
            text-align: right;
        }
        
        input {
            padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none;
            margin: 10px 0; text-align: center; width: 300px; font-family: 'Tajawal';
        }

        button {
            padding: 15px 50px; font-size: 1.5rem; background: #27ae60; color: white;
            border: none; border-radius: 8px; cursor: pointer; font-family: 'Tajawal';
            box-shadow: 0 4px 0 #1e8449; z-index: 101; margin-top: 10px;
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="left-zone" class="click-zone" onclick="handleInput('left')"></div>
    <div id="right-zone" class="click-zone" onclick="handleInput('right')"></div>

    <div id="instructions">
        <h1 style="color:#3498db; margin-bottom: 10px;">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø§Ø¨Ø· Ø§Ù„Ø¶Ù…Ù†ÙŠ</h1>
        <h3 style="color:#bdc3c7; margin-top: 0;">(Implicit Association Test)</h3>
        
        <div class="instruction-box">
            <h3 style="text-align: center; color: #f1c40f;">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:</h3>
            <ul>
                <li>Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰.</li>
                <li>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ Ù‡Ùˆ <strong>ØªØµÙ†ÙŠÙ Ø§Ù„ÙƒÙ„Ù…Ø©</strong> Ø¨Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ† ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙˆØ£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±.</li>
                <li><strong>Ù„Ù„ØªØµÙ†ÙŠÙ Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…ÙŠÙ†:</strong> Ø§Ø¶ØºØ· Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ (Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³) ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ <strong>ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©</strong>.</li>
                <li><strong>Ù„Ù„ØªØµÙ†ÙŠÙ Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø§Ø±:</strong> Ø§Ø¶ØºØ· Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ (Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³) ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ <strong>ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©</strong>.</li>
                <li>Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø¹Ù„Ø§Ù…Ø© (âŒ) Ø­Ù…Ø±Ø§Ø¡ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù†Ùƒ Ø£Ø®Ø·Ø£ØªØ› ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„ØªÙƒÙ…Ù„.</li>
                <li><strong>Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ø¯Ù‚Ø©</strong> Ù…Ø·Ù„ÙˆØ¨ØªØ§Ù† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</li>
            </ul>
        </div>
        
        <input type="text" id="student-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨">
        <button onclick="startExperiment()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </div>

    <div id="main-container" class="hidden">
        <div class="header-labels">
            <div id="left-label" class="left-label">...</div>
            <div id="right-label" class="right-label">...</div>
        </div>
        <div id="stimulus-box">Ø§Ø³ØªØ¹Ø¯</div>
        <div id="error-msg">âŒ</div>
    </div>

    <script>
        // ================================================================
        //  Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        // ================================================================
        const SCRIPT_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_ØªØ·Ø¨ÙŠÙ‚_Ø§Ù„ÙˆÙŠØ¨_Ø§Ù„Ø®Ø§Øµ_Ø¨Ùƒ_Ù‡Ù†Ø§_Ø¨ÙŠÙ†_Ø¹Ù„Ø§Ù…ØªÙŠ_Ø§Ù„ØªÙ†ØµÙŠØµ"; 
        
        // Ù…Ø«Ø§Ù„: "https://script.google.com/macros/s/AKfycbx.../exec"

        const categories = {
            flowers: ["Ø£ÙˆØ±ÙƒÙŠØ¯", "ØªÙˆÙ„ÙŠØ¨", "ÙˆØ±Ø¯", "ÙŠØ§Ø³Ù…ÙŠÙ†", "Ù†Ø±Ø¬Ø³", "Ù„ÙŠÙ„Ùƒ", "Ù„ÙˆØªØ³"],
            insects: ["Ø¯Ø¨ÙˆØ±", "Ø¨Ø±ØºÙˆØ«", "Ø¹Ù†ÙƒØ¨ÙˆØª", "ØµØ±ØµÙˆØ±", "Ø¨Ø¹ÙˆØ¶Ø©", "Ù†Ù…Ù„Ø©", "Ø°Ø¨Ø§Ø¨"],
            good: ["Ø±Ø§Ø¦Ø¹", "Ø¬Ù…ÙŠÙ„", "Ø³Ø¹ÙŠØ¯", "Ø­Ø¨", "ÙØ±Ø­", "Ø³Ù„Ø§Ù…", "Ù†Ø¬Ø§Ø­"],
            bad: ["Ù‚Ø¨ÙŠØ­", "ÙØ§Ø´Ù„", "Ø­Ø²Ù†", "Ø£Ù„Ù…", "Ø´Ø±", "ÙƒØ±Ù‡", "Ù…Ø±Ø¶"]
        };

        const blocks = [
            { type: 'practice', left: ['flowers'], right: ['insects'], trials: 4 },
            { type: 'practice', left: ['good'], right: ['bad'], trials: 4 },
            { type: 'test_compatible', left: ['flowers', 'good'], right: ['insects', 'bad'], trials: 10 },
            { type: 'practice_reverse', left: ['insects'], right: ['flowers'], trials: 6 },
            { type: 'test_incompatible', left: ['insects', 'good'], right: ['flowers', 'bad'], trials: 12 }
        ];

        let currentBlock = 0;
        let currentTrial = 0;
        let blockTrials = [];
        let results = [];
        let startTime = 0;
        let studentName = "";
        let waitingForCorrection = false;

        function startExperiment() {
            const name = document.getElementById('student-name').value.trim();
            if (!name) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¨Ø¯Ø¡"); return; }
            studentName = name;

            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');
            startBlock();
        }

        function startBlock() {
            if (currentBlock >= blocks.length) {
                finishExperiment();
                return;
            }

            const block = blocks[currentBlock];
            document.getElementById('left-label').innerHTML = block.left.map(getLabel).join("<br>");
            document.getElementById('right-label').innerHTML = block.right.map(getLabel).join("<br>");
            updateColors(block);

            blockTrials = generateTrials(block);
            currentTrial = 0;
            waitingForCorrection = false;
            setTimeout(nextTrial, 500);
        }

        function updateColors(block) {
            const isLeftBad = block.left.includes('bad') || block.left.includes('insects');
            const isRightBad = block.right.includes('bad') || block.right.includes('insects');
            document.getElementById('left-label').style.color = isLeftBad ? "#e74c3c" : "#3498db";
            document.getElementById('right-label').style.color = isRightBad ? "#e74c3c" : "#3498db";
        }

        function getLabel(cat) {
            if(cat === 'flowers') return "Ø²Ù‡ÙˆØ± ğŸŒ¸";
            if(cat === 'insects') return "Ø­Ø´Ø±Ø§Øª ğŸ¦—";
            if(cat === 'good') return "ÙƒÙ„Ù…Ø§Øª Ø¬ÙŠØ¯Ø© ğŸ‘";
            if(cat === 'bad') return "ÙƒÙ„Ù…Ø§Øª Ø³ÙŠØ¦Ø© ğŸ‘";
            return "";
        }

        function generateTrials(block) {
            let trials = [];
            for (let i = 0; i < block.trials; i++) {
                const isLeft = Math.random() < 0.5;
                const sideCats = isLeft ? block.left : block.right;
                const category = sideCats[Math.floor(Math.random() * sideCats.length)];
                const word = categories[category][Math.floor(Math.random() * categories[category].length)];
                trials.push({ word: word, category: category, correctSide: isLeft ? 'left' : 'right' });
            }
            return trials;
        }

        function nextTrial() {
            if (currentTrial >= blockTrials.length) {
                currentBlock++;
                startBlock();
                return;
            }
            const trial = blockTrials[currentTrial];
            document.getElementById('stimulus-box').textContent = trial.word;
            document.getElementById('error-msg').style.display = 'none';
            waitingForCorrection = false;
            
            if (categories.good.includes(trial.word)) document.getElementById('stimulus-box').style.color = "#3498db";
            else if (categories.bad.includes(trial.word)) document.getElementById('stimulus-box').style.color = "#e74c3c";
            else document.getElementById('stimulus-box').style.color = "#ecf0f1";
            
            startTime = Date.now();
        }

        function handleInput(side) {
            if (currentBlock >= blocks.length) return;
            const trial = blockTrials[currentTrial];
            
            if (waitingForCorrection) {
                if (side === trial.correctSide) {
                    document.getElementById('error-msg').style.display = 'none';
                    waitingForCorrection = false;
                    currentTrial++;
                    setTimeout(nextTrial, 150);
                }
                return;
            }

            const endTime = Date.now();
            const rt = endTime - startTime;

            if (side === trial.correctSide) {
                if (blocks[currentBlock].type.includes('test')) {
                    results.push({ block: blocks[currentBlock].type, rt: rt, correct: true });
                }
                currentTrial++;
                setTimeout(nextTrial, 150);
            } else {
                document.getElementById('error-msg').style.display = 'block';
                waitingForCorrection = true;
            }
        }

        function finishExperiment() {
            document.getElementById('main-container').classList.add('hidden');
            document.getElementById('left-zone').style.display = 'none';
            document.getElementById('right-zone').style.display = 'none';
            document.getElementById('instructions').innerHTML = "<h2 style='color:#f1c40f'>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h2>";
            document.getElementById('instructions').classList.remove('hidden');

            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø­ÙØ¸ ÙÙ‚Ø·)
            const compTrials = results.filter(r => r.block === 'test_compatible');
            const incompTrials = results.filter(r => r.block === 'test_incompatible');
            const avgComp = compTrials.reduce((sum, r) => sum + r.rt, 0) / (compTrials.length || 1);
            const avgIncomp = incompTrials.reduce((sum, r) => sum + r.rt, 0) / (incompTrials.length || 1);
            const diff = avgIncomp - avgComp;
            
            let interpretation = "Ø­ÙŠØ§Ø¯ÙŠ";
            if (diff > 50) interpretation = "Ø§Ù†Ø­ÙŠØ§Ø² Ù„Ù„Ø²Ù‡ÙˆØ±";
            else if (diff < -50) interpretation = "Ø§Ù†Ø­ÙŠØ§Ø² Ù„Ù„Ø­Ø´Ø±Ø§Øª";

            const dataToSend = {
                student_name: studentName,
                test_type: "IAT (Implicit Association)",
                score: Math.round(diff) + " ms",
                details: `Compatible: ${Math.round(avgComp)}ms | Incompatible: ${Math.round(avgIncomp)}ms`,
                interpretation: interpretation
            };

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            if (SCRIPT_URL.includes("Ø¶Ø¹_Ø±Ø§Ø¨Ø·")) {
                alert("ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ØªÙ‚Ù… Ø¨ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Google Script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ØŒ Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                document.getElementById('instructions').innerHTML = "<h1>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·)</h1>";
                return;
            }

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dataToSend)
            }).then(() => {
                document.getElementById('instructions').innerHTML = `
                    <h1 style="color:#27ae60">ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!</h1>
                    <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†Ùƒ.</p>
                    <button onclick="location.reload()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
                `;
            }).catch(error => {
                document.getElementById('instructions').innerHTML = "<p style='color:red'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù„ÙƒÙ†Ùƒ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>";
            });
        }
    </script>
</body>
</html>
