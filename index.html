<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØ¯Ø§Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ù…Ù†ÙŠØ© (Ù†Ø³Ø®Ø© Ø³Ø±ÙŠØ¹Ø©)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #222;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            touch-action: manipulation;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-labels {
            display: flex;
            justify-content: space-between;
            width: 95%;
            margin: 10px auto;
            font-size: 20px;
            font-weight: bold;
        }

        .label-box {
            width: 45%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }

        .left-label { text-align: right; color: #3498db; border-bottom: 4px solid #3498db; }
        .right-label { text-align: left; color: #2ecc71; border-bottom: 4px solid #2ecc71; }

        .stimulus-box {
            font-size: 60px;
            font-weight: 900;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            color: #fff;
            text-shadow: 0 4px 15px rgba(0,0,0,0.7);
        }

        .response-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 140px;
            display: flex;
            z-index: 100;
        }

        .btn-resp {
            width: 50%;
            border: none;
            font-family: 'Tajawal';
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.9;
            transition: 0.1s;
        }
        
        .btn-left { background-color: #2c3e50; color: #3498db; border-right: 2px solid #444; }
        .btn-right { background-color: #2c3e50; color: #2ecc71; }
        
        .btn-resp:active { background-color: #555; }

        #error-msg {
            color: #e74c3c;
            font-size: 50px;
            font-weight: bold;
            visibility: hidden;
            height: 60px;
        }

        .instruction-screen {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            margin: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .btn-start {
            background: #27ae60;
            color: white;
            padding: 15px 50px;
            border: none;
            border-radius: 8px;
            font-size: 22px;
            margin-top: 20px;
            cursor: pointer;
            font-family: 'Tajawal';
            font-weight: bold;
        }

        .hidden { display: none !important; }
        
        .word-good { color: #2ecc71; }
        .word-bad { color: #e74c3c; }
        .word-neutral { color: #ecf0f1; }

        @media (max-width: 600px) {
            .header-labels { font-size: 16px; }
            .stimulus-box { font-size: 45px; }
            .btn-resp { font-size: 20px; height: 120px; }
        }
    </style>
</head>
<body>

    <div id="start-screen" class="instruction-screen">
        <h1 style="color:#2c3e50;">Ø§Ø®ØªØ¨Ø§Ø± IAT (Ù†Ø³Ø®Ø© Ø³Ø±ÙŠØ¹Ø©)</h1>
        <p style="font-size:18px;">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ØªØµÙ†ÙŠÙ Ø§Ù„ÙƒÙ„Ù…Ø§Øª <strong>Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©</strong>.</p>
        
        <div style="text-align: right; background:#f9f9f9; padding:15px; border-radius:10px; margin:15px 0;">
            <p>ğŸ‘ˆ Ø§Ø¶ØºØ· <strong>ÙŠØ³Ø§Ø±</strong> Ù„Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ÙŠØ³Ø±.</p>
            <p>ğŸ‘‰ Ø§Ø¶ØºØ· <strong>ÙŠÙ…ÙŠÙ†</strong> Ù„Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ÙŠÙ…Ù†.</p>
            <p>â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: 45 Ø«Ø§Ù†ÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹.</p>
        </div>

        <input type="text" id="student-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù‡Ù†Ø§" 
               style="padding:15px; width:80%; font-size:18px; border:2px solid #ddd; border-radius:8px; text-align:center; margin-bottom:15px;">
        <br>
        <button class="btn-start" onclick="initTest()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </div>

    <div id="test-screen" class="container hidden">
        <div class="header-labels">
            <div id="label-left" class="label-box left-label">...</div>
            <div id="label-right" class="label-box right-label">...</div>
        </div>

        <div id="stimulus" class="stimulus-box">...</div>
        <div id="error-msg">âŒ</div>

        <div class="response-area">
            <button class="btn-resp btn-left" onmousedown="handleInput('left')" ontouchstart="handleInput('left')">Ø§Ù„ÙŠØ³Ø§Ø±</button>
            <button class="btn-resp btn-right" onmousedown="handleInput('right')" ontouchstart="handleInput('right')">Ø§Ù„ÙŠÙ…ÙŠÙ†</button>
        </div>
    </div>

    <div id="end-screen" class="instruction-screen hidden">
        <h1 style="color:#27ae60">âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
        <p style="font-size:20px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø³Ø±Ø¹ØªÙƒ!</p>
        <hr>
        <div id="result-display" style="font-weight:bold; margin:20px; font-size:22px; color:#2c3e50;">
            Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...
        </div>
        <button class="btn-start" onclick="location.reload()" style="background:#34495e;">Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <script>
        // ==========================================
        //  Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwbCrZKaEWWAfFy3csc-fUzfJv4CzjqEYRY1dC60rpscTe65CffuyA25ViS207AtaRS/exec"; 
        // ==========================================

        const categories = {
            target1: { name: "Ø²Ù‡ÙˆØ± ğŸŒ¸", words: ["ÙŠØ§Ø³Ù…ÙŠÙ†", "Ø¬ÙˆØ±ÙŠ", "Ù†Ø±Ø¬Ø³", "ØªÙˆÙ„ÙŠØ¨"], type: "neutral" },
            target2: { name: "Ø­Ø´Ø±Ø§Øª ğŸ¦—", words: ["ØµØ±ØµÙˆØ±", "Ø°Ø¨Ø§Ø¨Ø©", "Ø¨Ø¹ÙˆØ¶Ø©", "Ø¹Ù†ÙƒØ¨ÙˆØª"], type: "neutral" },
            attr1:   { name: "Ø¬ÙŠØ¯ ğŸ‘", words: ["Ø­Ø¨", "Ø³Ù„Ø§Ù…", "ÙØ±Ø­", "Ù†Ø¬Ø§Ø­"], type: "good" },
            attr2:   { name: "Ø³ÙŠØ¡ ğŸ‘", words: ["ÙƒØ±Ù‡", "Ø­Ø±Ø¨", "Ø£Ù„Ù…", "ÙØ´Ù„"], type: "bad" }
        };

        // --- Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø®ØªØµØ±Ø© (Ù…Ø¬Ù…ÙˆØ¹ 36 ÙƒÙ„Ù…Ø© ÙÙ‚Ø·) ---
        let blocks = [
            // 1. ØªØ¯Ø±ÙŠØ¨ Ø¨Ø³ÙŠØ· (4 ÙƒÙ„Ù…Ø§Øª)
            { type: "practice", left: ["target1"], right: ["target2"], trials: 4, info: "ØªØ¯Ø±ÙŠØ¨: Ø²Ù‡ÙˆØ± (ÙŠØ³Ø§Ø±) / Ø­Ø´Ø±Ø§Øª (ÙŠÙ…ÙŠÙ†)" },
            
            // 2. ØªØ¯Ø±ÙŠØ¨ ØµÙØ§Øª (4 ÙƒÙ„Ù…Ø§Øª)
            { type: "practice", left: ["attr1"], right: ["attr2"], trials: 4, info: "ØªØ¯Ø±ÙŠØ¨: Ø¬ÙŠØ¯ (ÙŠØ³Ø§Ø±) / Ø³ÙŠØ¡ (ÙŠÙ…ÙŠÙ†)" },
            
            // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆØ§ÙÙ‚ (10 ÙƒÙ„Ù…Ø§Øª) - Ø²Ù‡ÙˆØ±+Ø¬ÙŠØ¯
            { type: "test_compatible", left: ["target1", "attr1"], right: ["target2", "attr2"], trials: 10, info: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø²Ù‡ÙˆØ±+Ø¬ÙŠØ¯ (ÙŠØ³Ø§Ø±) / Ø­Ø´Ø±Ø§Øª+Ø³ÙŠØ¡ (ÙŠÙ…ÙŠÙ†)" },
            
            // 4. ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹ÙƒØ³ (6 ÙƒÙ„Ù…Ø§Øª)
            { type: "practice_reverse", left: ["target2"], right: ["target1"], trials: 6, info: "Ø§Ù†ØªØ¨Ù‡! ØªÙ… Ø§Ù„Ø¹ÙƒØ³: Ø­Ø´Ø±Ø§Øª (ÙŠØ³Ø§Ø±) / Ø²Ù‡ÙˆØ± (ÙŠÙ…ÙŠÙ†)" }, 
            
            // 5. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ†Ø§Ù‚Ø¶ (12 ÙƒÙ„Ù…Ø©) - Ø­Ø´Ø±Ø§Øª+Ø¬ÙŠØ¯
            { type: "test_incompatible", left: ["target2", "attr1"], right: ["target1", "attr2"], trials: 12, info: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø­Ø´Ø±Ø§Øª+Ø¬ÙŠØ¯ (ÙŠØ³Ø§Ø±) / Ø²Ù‡ÙˆØ±+Ø³ÙŠØ¡ (ÙŠÙ…ÙŠÙ†)" }
        ];

        let currentBlock = 0;
        let trialIndex = 0;
        let trialQueue = [];
        let currentStimulus = null;
        let startTime = 0;
        let isBlockRunning = false;
        let studentName = "";
        
        let results = {
            compatibleTimes: [],
            incompatibleTimes: [],
            totalErrors: 0
        };

        function initTest() {
            const name = document.getElementById('student-name').value.trim();
            if(!name) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹"); return; }
            studentName = name;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('test-screen').classList.remove('hidden');
            
            startBlock(0);
        }

        function startBlock(blockIdx) {
            currentBlock = blockIdx;
            if (currentBlock >= blocks.length) {
                finishExperiment();
                return;
            }

            const blockInfo = blocks[currentBlock];
            const leftNames = blockInfo.left.map(k => categories[k].name).join(" + ");
            const rightNames = blockInfo.right.map(k => categories[k].name).join(" + ");
            
            document.getElementById('label-left').textContent = leftNames;
            document.getElementById('label-right').textContent = rightNames;

            const stimBox = document.getElementById('stimulus');
            stimBox.textContent = blockInfo.info;
            stimBox.style.fontSize = "26px"; // Ø®Ø· Ø£ØµØºØ± Ù„Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
            stimBox.className = "stimulus-box"; 
            isBlockRunning = false;

            generateTrials(blockInfo);
            
            // ÙˆÙ‚Øª Ø§Ù†ØªØ¸Ø§Ø± Ø£Ù‚Ù„ (Ø«Ø§Ù†ÙŠØªÙŠÙ†) Ù„Ù„Ø³Ø±Ø¹Ø©
            setTimeout(nextTrial, 2000);
        }

        function generateTrials(blockInfo) {
            trialQueue = [];
            let possibleStimuli = [];

            blockInfo.left.forEach(key => {
                categories[key].words.forEach(w => {
                    possibleStimuli.push({ word: w, correctSide: 'left', type: categories[key].type });
                });
            });

            blockInfo.right.forEach(key => {
                categories[key].words.forEach(w => {
                    possibleStimuli.push({ word: w, correctSide: 'right', type: categories[key].type });
                });
            });

            for(let i=0; i<blockInfo.trials; i++) {
                const rand = possibleStimuli[Math.floor(Math.random() * possibleStimuli.length)];
                trialQueue.push(rand);
            }
            trialIndex = 0;
        }

        function nextTrial() {
            if (trialIndex >= trialQueue.length) {
                startBlock(currentBlock + 1);
                return;
            }

            currentStimulus = trialQueue[trialIndex];
            const stimBox = document.getElementById('stimulus');
            stimBox.textContent = currentStimulus.word;
            stimBox.style.fontSize = "60px";
            
            stimBox.className = "stimulus-box";
            if(currentStimulus.type === 'good') stimBox.classList.add('word-good');
            else if(currentStimulus.type === 'bad') stimBox.classList.add('word-bad');
            else stimBox.classList.add('word-neutral');

            document.getElementById('error-msg').style.visibility = 'hidden';
            
            startTime = Date.now();
            isBlockRunning = true;
        }

        function handleInput(side) {
            if (!isBlockRunning) return;
            isBlockRunning = false; 

            if (side === currentStimulus.correctSide) {
                const endTime = Date.now();
                const reactionTime = endTime - startTime;

                const blockType = blocks[currentBlock].type;
                if (blockType === "test_compatible") {
                    results.compatibleTimes.push(reactionTime);
                } else if (blockType === "test_incompatible") {
                    results.incompatibleTimes.push(reactionTime);
                }

                trialIndex++;
                setTimeout(nextTrial, 150); // Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹
            } else {
                document.getElementById('error-msg').style.visibility = 'visible';
                results.totalErrors++;
                isBlockRunning = true; 
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'e') handleInput('left');
            if (e.key.toLowerCase() === 'i') handleInput('right');
        });

        function finishExperiment() {
            document.getElementById('test-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');

            const cleanComp = results.compatibleTimes.filter(t => t > 200 && t < 4000);
            const cleanIncomp = results.incompatibleTimes.filter(t => t > 200 && t < 4000);

            const avgComp = calculateAverage(cleanComp);
            const avgIncomp = calculateAverage(cleanIncomp);
            const diff = avgIncomp - avgComp; 
            
            let interpretation = "";
            if (diff > 0) interpretation = "ØªÙØ¶ÙŠÙ„ Ø¶Ù…Ù†ÙŠ Ù„Ù„Ø²Ù‡ÙˆØ± ğŸŒ¸";
            else interpretation = "ØªÙØ¶ÙŠÙ„ Ø¶Ù…Ù†ÙŠ Ù„Ù„Ø­Ø´Ø±Ø§Øª ğŸ¦— (Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ¶ÙŠÙ„)";

            document.getElementById('result-display').innerHTML = `
                <span style="color:#2980b9">Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${interpretation}</span><br>
                <span style="font-size:16px; color:#7f8c8d">ÙØ±Ù‚ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${Math.round(diff)} ms</span>
            `;

            const dataToSend = {
                student_name: studentName,
                iat_score: Math.round(diff),
                interpretation: interpretation,
                compatible_avg: Math.round(avgComp),
                incompatible_avg: Math.round(avgIncomp),
                total_errors: results.totalErrors
            };

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dataToSend)
            }).then(() => {
                console.log("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
            }).catch(e => {
                console.error("Ø®Ø·Ø£", e);
            });
        }

        function calculateAverage(arr) {
            if (arr.length === 0) return 0;
            const sum = arr.reduce((a, b) => a + b, 0);
            return sum / arr.length;
        }
    </script>
</body>
</html>
